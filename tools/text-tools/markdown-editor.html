<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor - Free Online Tool</title>
    <meta name="description" content="Free online markdown editor with live preview, syntax highlighting, and common markdown shortcuts.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .editor-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .editor-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .editor-section {
            flex: 1;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
        }
        .preview-section {
            flex: 1;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            overflow-y: auto;
        }
        .toolbar {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        .toolbar button {
            margin: 0.25rem;
        }
        .CodeMirror {
            height: 500px;
            border-radius: 5px;
        }
        .preview-content {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }
        .preview-content img {
            max-width: 100%;
            height: auto;
        }
        .preview-content table {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        .preview-content table th,
        .preview-content table td {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
        }
        .preview-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
        }
        .preview-content code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }
        .preview-content blockquote {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin-left: 0;
            color: #6c757d;
        }
        .cheat-sheet {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        .cheat-sheet.show {
            right: 0;
        }
        .cheat-sheet-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1001;
        }
        .theme-switcher {
            position: fixed;
            right: 20px;
            bottom: 80px;
            z-index: 1001;
        }
        .stats-bar {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .stats-item i {
            font-size: 1rem;
        }
        .misspelled {
            text-decoration: underline wavy red;
            cursor: pointer;
        }
        .spell-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .spell-suggestions.show {
            display: block;
        }
        .shortcut-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
            background: #f8f9fa;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
        #autoSaveStatus {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.8);
            color: #fff;
            border-radius: 20px;
            display: none;
            z-index: 1001;
        }
        .font-size-control {
            position: fixed;
            right: 20px;
            bottom: 140px;
            z-index: 1001;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 0.5rem;
        }
        .search-replace {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        .search-replace.show {
            display: block;
        }
        .print-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 1002;
            padding: 2rem;
            overflow-y: auto;
            display: none;
        }
        .print-view.show {
            display: block;
        }
        .drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            color: #6c757d;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            z-index: 1000;
            pointer-events: none;
        }
        .drop-zone.active {
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        .drop-zone i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .section-fold {
            cursor: pointer;
            user-select: none;
            color: #6c757d;
        }
        .section-fold:hover {
            color: #0d6efd;
        }
        .folded {
            display: none;
        }
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        .tab {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #fff;
        }
        .tab.active {
            background: #e9ecef;
        }
        .tab-close {
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            border-radius: 50%;
        }
        .tab-close:hover {
            background: #dee2e6;
        }
        .format-options {
            position: fixed;
            right: 20px;
            bottom: 200px;
            z-index: 1001;
        }
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 1003;
            display: none;
            padding: 2rem;
        }
        .focus-mode.show {
            display: block;
        }
        .focus-content {
            max-width: 800px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .focus-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .focus-editor {
            flex: 1;
            overflow: hidden;
        }
        .file-history {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        .file-history.show {
            left: 0;
        }
        .history-item {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover {
            background: #f8f9fa;
        }
        .history-item.active {
            background: #e9ecef;
        }
        .history-close {
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            border-radius: 50%;
        }
        .history-close:hover {
            background: #dee2e6;
        }
        @media print {
            .container {
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            .editor-card {
                box-shadow: none;
                padding: 0;
            }
            .toolbar, .stats-bar, .editor-section, .actions, .theme-switcher,
            .cheat-sheet-toggle, .font-size-control, #autoSaveStatus {
                display: none !important;
            }
            .preview-section {
                border: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header will be loaded dynamically -->
    <div id="header-placeholder"></div>

    <main class="container py-4">
        <h1 class="text-center mb-4">Markdown Editor</h1>
        
        <!-- Ad Space -->
        <div class="ad-space text-center mb-4">
            <div class="bg-light p-3">
                <!-- Ad code will go here -->
                <p class="text-muted m-0">Advertisement</p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="editor-card">
                    <!-- Toolbar -->
                    <div class="toolbar">
                        <button class="btn btn-sm btn-outline-secondary" data-action="bold" title="Bold (Ctrl+B)">
                            <i class="bi bi-type-bold"></i> Bold
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="italic" title="Italic (Ctrl+I)">
                            <i class="bi bi-type-italic"></i> Italic
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="heading" title="Heading">
                            <i class="bi bi-type-h1"></i> Heading
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="link" title="Link (Ctrl+K)">
                            <i class="bi bi-link"></i> Link
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="image" title="Image">
                            <i class="bi bi-image"></i> Image
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="code" title="Code">
                            <i class="bi bi-code"></i> Code
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="quote" title="Quote">
                            <i class="bi bi-chat-quote"></i> Quote
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="ul" title="Unordered List">
                            <i class="bi bi-list-ul"></i> List
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="ol" title="Ordered List">
                            <i class="bi bi-list-ol"></i> Numbered List
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="table" title="Table">
                            <i class="bi bi-table"></i> Table
                        </button>
                        <div class="btn-group ms-2">
                            <button class="btn btn-sm btn-outline-secondary" data-action="search-replace" title="Search & Replace (Ctrl+F)">
                                <i class="bi bi-search"></i> Search
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-action="print" title="Print View">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                        <div class="btn-group ms-2">
                            <button class="btn btn-sm btn-outline-secondary" data-action="toggle-line-numbers" title="Toggle Line Numbers">
                                <i class="bi bi-list-ol"></i> Line Numbers
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-action="toggle-section-fold" title="Toggle Section Folding">
                                <i class="bi bi-arrows-collapse"></i> Fold Sections
                            </button>
                        </div>
                        <div class="btn-group ms-2">
                            <button class="btn btn-sm btn-outline-secondary" data-action="focus" title="Focus Mode">
                                <i class="bi bi-eye"></i> Focus
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-action="fullscreen" title="Fullscreen Mode">
                                <i class="bi bi-arrows-angle-expand"></i> Fullscreen
                            </button>
                        </div>
                    </div>

                    <!-- Stats Bar -->
                    <div class="stats-bar">
                        <div class="stats-item">
                            <i class="bi bi-file-text"></i>
                            <span id="wordCount">0 words</span>
                        </div>
                        <div class="stats-item">
                            <i class="bi bi-clock"></i>
                            <span id="readingTime">0 min read</span>
                        </div>
                        <div class="stats-item">
                            <i class="bi bi-spellcheck"></i>
                            <span id="spellStatus">Spell check: Off</span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="spellCheckToggle">
                            <label class="form-check-label" for="spellCheckToggle">Spell Check</label>
                        </div>
                    </div>

                    <!-- Editor Container -->
                    <div class="editor-container">
                        <!-- Editor Section -->
                        <div class="editor-section">
                            <h5 class="mb-3">Editor</h5>
                            <textarea id="editor"></textarea>
                        </div>

                        <!-- Preview Section -->
                        <div class="preview-section">
                            <h5 class="mb-3">Preview</h5>
                            <div id="preview" class="preview-content"></div>
                        </div>
                    </div>

                    <!-- Search and Replace -->
                    <div class="search-replace">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search for...">
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control" id="replaceInput" placeholder="Replace with...">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" id="replaceBtn">Replace</button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" id="findPrevBtn">Previous</button>
                            <button class="btn btn-sm btn-outline-secondary" id="findNextBtn">Next</button>
                            <button class="btn btn-sm btn-outline-secondary" id="replaceAllBtn">Replace All</button>
                            <span class="ms-2" id="searchStatus"></span>
                        </div>
                    </div>

                    <!-- Drop Zone -->
                    <div class="drop-zone">
                        <div>
                            <i class="bi bi-file-earmark-arrow-down"></i>
                            <h4>Drop your file here</h4>
                            <p>Supported formats: .md, .txt</p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary" data-action="copy-html">Copy HTML</button>
                                <button class="btn btn-outline-secondary" data-action="copy-markdown">Copy Markdown</button>
                            </div>

                            <!-- File Operations -->
                            <div class="btn-group ms-2" role="group">
                                <button class="btn btn-outline-primary" data-action="import-file">Import File</button>
                                <button class="btn btn-outline-primary" data-action="export-markdown">Export .md</button>
                                <button class="btn btn-outline-primary" data-action="export-pdf">Export PDF</button>
                            </div>

                            <!-- Image Upload -->
                            <div class="btn-group ms-2" role="group">
                                <button class="btn btn-outline-success" data-action="upload-image">Upload Image</button>
                            </div>

                            <input type="file" id="fileInput" accept=".md,.txt" style="display: none;">
                            <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked>
                                <label class="form-check-label" for="autoSaveToggle">Auto Save</label>
                            </div>
                            <button class="btn btn-danger" id="clear">Clear</button>
                        </div>
                    </div>

                    <!-- Image Upload Progress -->
                    <div id="uploadProgress" class="progress mt-2" style="display: none; height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ad Space -->
        <div class="ad-space text-center mt-4">
            <div class="bg-light p-3">
                <!-- Ad code will go here -->
                <p class="text-muted m-0">Advertisement</p>
            </div>
        </div>

        <!-- Markdown Cheat Sheet -->
        <div class="cheat-sheet">
            <h5 class="mb-3">Markdown Cheat Sheet</h5>
            <div class="list-group">
                <div class="list-group-item">
                    <h6>Headers</h6>
                    <code># H1</code>
                    <code>## H2</code>
                    <code>### H3</code>
                </div>
                <div class="list-group-item">
                    <h6>Emphasis</h6>
                    <code>**bold**</code>
                    <code>*italic*</code>
                    <code>~~strikethrough~~</code>
                </div>
                <div class="list-group-item">
                    <h6>Lists</h6>
                    <code>- Unordered</code>
                    <code>1. Ordered</code>
                </div>
                <div class="list-group-item">
                    <h6>Links & Images</h6>
                    <code>[link](url)</code>
                    <code>![image](url)</code>
                </div>
                <div class="list-group-item">
                    <h6>Code</h6>
                    <code>`inline code`</code>
                    <code>```
code block
```</code>
                </div>
                <div class="list-group-item">
                    <h6>Keyboard Shortcuts</h6>
                    <p><span class="shortcut-badge">Ctrl + B</span> Bold</p>
                    <p><span class="shortcut-badge">Ctrl + I</span> Italic</p>
                    <p><span class="shortcut-badge">Ctrl + K</span> Link</p>
                    <p><span class="shortcut-badge">Ctrl + S</span> Save</p>
                    <p><span class="shortcut-badge">Ctrl + /</span> Toggle Cheat Sheet</p>
                </div>
            </div>
        </div>

        <button class="btn btn-primary rounded-circle cheat-sheet-toggle" title="Toggle Cheat Sheet">
            <i class="bi bi-question-lg"></i>
        </button>

        <div class="btn-group-vertical theme-switcher">
            <button class="btn btn-sm btn-outline-primary" data-theme="default">Default</button>
            <button class="btn btn-sm btn-outline-primary" data-theme="dark">Dark</button>
            <button class="btn btn-sm btn-outline-primary" data-theme="light">Light</button>
        </div>

        <div id="autoSaveStatus">Changes saved</div>

        <!-- Spell Check Suggestions -->
        <div class="spell-suggestions" id="spellSuggestions"></div>

        <!-- Font Size Control -->
        <div class="font-size-control">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" data-action="font-decrease">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" data-action="font-reset">
                    100%
                </button>
                <button class="btn btn-sm btn-outline-secondary" data-action="font-increase">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>

        <!-- Print View -->
        <div class="print-view">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Print Preview</h1>
                <button class="btn btn-outline-secondary" id="closePrintView">
                    <i class="bi bi-x-lg"></i> Close
                </button>
            </div>
            <div id="printContent"></div>
        </div>

        <div class="tabs" id="documentTabs">
            <button class="btn btn-sm btn-outline-secondary" id="newTab">
                <i class="bi bi-plus-lg"></i> New Tab
            </button>
        </div>

        <div class="format-options">
            <button class="btn btn-sm btn-outline-secondary" data-action="format" title="Format Document">
                <i class="bi bi-text-paragraph"></i>
            </button>
        </div>

        <div class="focus-mode">
            <div class="focus-content">
                <div class="focus-toolbar">
                    <h4>Focus Mode</h4>
                    <button class="btn btn-sm btn-outline-secondary" id="exitFocus">
                        <i class="bi bi-x-lg"></i> Exit
                    </button>
                </div>
                <div class="focus-editor">
                    <textarea id="focusEditor"></textarea>
                </div>
            </div>
        </div>

        <div class="file-history">
            <h5 class="mb-3">Recent Files</h5>
            <div id="historyList"></div>
        </div>

        <button class="btn btn-primary rounded-circle history-toggle" title="Show File History">
            <i class="bi bi-clock-history"></i>
        </button>
    </main>

    <!-- Footer will be loaded dynamically -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'markdown',
            theme: 'monokai',
            lineNumbers: true,
            lineWrapping: true,
            spellcheck: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            extraKeys: {
                'Ctrl-B': (cm) => insertMarkdown(cm, '**', '**'),
                'Ctrl-I': (cm) => insertMarkdown(cm, '_', '_'),
                'Ctrl-K': (cm) => insertLink(cm),
                'Ctrl-S': (cm) => saveContent(),
                'Ctrl-/': toggleCheatSheet,
                'Ctrl-F': toggleSearch
            }
        });

        // Initialize marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false
        });

        // DOM Elements
        const preview = document.getElementById('preview');
        const copyHtmlBtn = document.getElementById('copyHtml');
        const copyMarkdownBtn = document.getElementById('copyMarkdown');
        const clearBtn = document.getElementById('clear');
        const toolbar = document.querySelector('.toolbar');

        // Update preview and stats on editor changes
        editor.on('change', () => {
            const markdown = editor.getValue();
            const html = marked.parse(markdown);
            preview.innerHTML = html;

            if (autoSaveToggle.checked) {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(saveContent, 1000);
            }

            updateStats(markdown);
            if (spellCheckToggle.checked) {
                checkSpelling();
            }
        });

        // Toolbar actions
        toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            switch (action) {
                case 'bold':
                    insertMarkdown(editor, '**', '**');
                    break;
                case 'italic':
                    insertMarkdown(editor, '_', '_');
                    break;
                case 'heading':
                    insertMarkdown(editor, '# ', '');
                    break;
                case 'link':
                    insertLink(editor);
                    break;
                case 'image':
                    insertMarkdown(editor, '![Alt text](', ')');
                    break;
                case 'code':
                    insertMarkdown(editor, '```\n', '\n```');
                    break;
                case 'quote':
                    insertMarkdown(editor, '> ', '');
                    break;
                case 'ul':
                    insertMarkdown(editor, '- ', '');
                    break;
                case 'ol':
                    insertMarkdown(editor, '1. ', '');
                    break;
                case 'table':
                    insertTable(editor);
                    break;
            }
        });

        // Helper functions
        function insertMarkdown(cm, start, end) {
            if (cm.somethingSelected()) {
                const selection = cm.getSelection();
                cm.replaceSelection(start + selection + end);
            } else {
                const pos = cm.getCursor();
                cm.replaceRange(start + end, pos);
                cm.setCursor(pos.line, pos.ch + start.length);
            }
            cm.focus();
        }

        function insertLink(cm) {
            if (cm.somethingSelected()) {
                const selection = cm.getSelection();
                cm.replaceSelection(`[${selection}](url)`);
            } else {
                const pos = cm.getCursor();
                cm.replaceRange('[text](url)', pos);
                cm.setCursor(pos.line, pos.ch + 1);
            }
            cm.focus();
        }

        function insertTable(cm) {
            const table = `| Header 1 | Header 2 | Header 3 |
|-----------|-----------|-----------|
| Cell 1    | Cell 2    | Cell 3    |
| Cell 4    | Cell 5    | Cell 6    |`;
            
            const pos = cm.getCursor();
            cm.replaceRange('\n' + table + '\n', pos);
            cm.focus();
        }

        // Copy buttons
        copyHtmlBtn.addEventListener('click', () => {
            const html = preview.innerHTML;
            navigator.clipboard.writeText(html)
                .then(() => alert('HTML copied to clipboard!'))
                .catch(err => console.error('Failed to copy HTML:', err));
        });

        copyMarkdownBtn.addEventListener('click', () => {
            const markdown = editor.getValue();
            navigator.clipboard.writeText(markdown)
                .then(() => alert('Markdown copied to clipboard!'))
                .catch(err => console.error('Failed to copy Markdown:', err));
        });

        // Clear button
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the editor?')) {
                editor.setValue('');
                preview.innerHTML = '';
            }
        });

        // File Operations
        document.querySelector('[data-action="import-file"]').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editor.setValue(e.target.result);
                    updatePreview();
                };
                reader.readAsText(file);
            }
        });

        document.querySelector('[data-action="export-markdown"]').addEventListener('click', () => {
            const content = editor.getValue();
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.querySelector('[data-action="export-pdf"]').addEventListener('click', async () => {
            const content = preview.innerHTML;
            const style = `
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
                    img { max-width: 100%; height: auto; }
                    code { background: #f4f4f4; padding: 2px 4px; border-radius: 4px; }
                    pre { background: #f4f4f4; padding: 15px; border-radius: 4px; }
                    blockquote { border-left: 4px solid #ddd; margin: 0; padding-left: 15px; }
                    table { border-collapse: collapse; width: 100%; }
                    th, td { border: 1px solid #ddd; padding: 8px; }
                    th { background-color: #f4f4f4; }
                </style>
            `;

            const html = `<!DOCTYPE html><html><head>${style}</head><body>${content}</body></html>`;

            try {
                const res = await fetch('https://api.html2pdf.app/v1/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer PDF_API_KEY'  // Replace PDF_API_KEY with your HTML2PDF API key
                    },
                    body: JSON.stringify({ html })
                });

                if (!res.ok) throw new Error('PDF generation failed');

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'document.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                alert('Failed to generate PDF. Please try again later.');
                console.error('PDF generation error:', err);
            }
        });

        // Image Upload
        document.querySelector('[data-action="upload-image"]').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const progress = document.getElementById('uploadProgress');
                progress.style.display = 'block';
                const progressBar = progress.querySelector('.progress-bar');

                try {
                    // Replace this with your preferred image hosting service
                    const formData = new FormData();
                    formData.append('image', file);

                    const res = await fetch('https://api.imgbb.com/1/upload?key=IMGBB_API_KEY', {  // Replace IMGBB_API_KEY with your ImgBB API key
                        method: 'POST',
                        body: formData
                    });

                    if (!res.ok) throw new Error('Upload failed');

                    const data = await res.json();
                    const imageUrl = data.data.url;
                    
                    // Insert image markdown at cursor position
                    const cursor = editor.getCursor();
                    const imageMarkdown = `![${file.name}](${imageUrl})`;
                    editor.replaceRange(imageMarkdown, cursor);
                    
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progress.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 1000);
                } catch (err) {
                    alert('Failed to upload image. Please try again.');
                    console.error('Image upload error:', err);
                    progress.style.display = 'none';
                }
            }
        });

        // Initial content
        const initialContent = `# Welcome to the Markdown Editor

This is a **live preview** markdown editor. Start typing in the editor on the left and see the rendered preview on the right.

## Features

- Live preview
- Syntax highlighting
- Common markdown shortcuts
- Copy HTML/Markdown
- Toolbar for common actions

## Example Table

| Feature | Description |
|---------|-------------|
| Preview | Live markdown preview |
| Syntax  | Highlighting for markdown |
| Export  | Copy as HTML or Markdown |

## Code Example

\`\`\`javascript
function hello() {
    console.log("Hello, World!");
}
\`\`\`

> Try editing this content or clear it to start fresh!
`;

        // Autosave functionality
        let autoSaveTimeout;
        const autoSaveToggle = document.getElementById('autoSaveToggle');
        const autoSaveStatus = document.getElementById('autoSaveStatus');

        function saveContent() {
            const content = editor.getValue();
            localStorage.setItem('markdownContent', content);
            showAutoSaveStatus();
        }

        function showAutoSaveStatus() {
            autoSaveStatus.style.display = 'block';
            setTimeout(() => {
                autoSaveStatus.style.display = 'none';
            }, 2000);
        }

        // Load saved content
        const savedContent = localStorage.getItem('markdownContent');
        if (savedContent) {
            editor.setValue(savedContent);
        } else {
            editor.setValue(initialContent);
        }

        // Cheat Sheet Toggle
        const cheatSheet = document.querySelector('.cheat-sheet');
        const cheatSheetToggle = document.querySelector('.cheat-sheet-toggle');

        function toggleCheatSheet() {
            cheatSheet.classList.toggle('show');
        }

        cheatSheetToggle.addEventListener('click', toggleCheatSheet);

        // Close cheat sheet when clicking outside
        document.addEventListener('click', (e) => {
            if (!cheatSheet.contains(e.target) && 
                !cheatSheetToggle.contains(e.target) && 
                cheatSheet.classList.contains('show')) {
                cheatSheet.classList.remove('show');
            }
        });

        // Keyboard shortcut for cheat sheet
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                toggleCheatSheet();
            }
        });

        // Stats functions
        function updateStats(text) {
            // Word count
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            const wordCount = words.length;
            document.getElementById('wordCount').textContent = `${wordCount} words`;

            // Reading time (assuming average reading speed of 200 words per minute)
            const minutes = Math.ceil(wordCount / 200);
            document.getElementById('readingTime').textContent = `${minutes} min read`;
        }

        // Theme switcher
        const themeSwitcher = document.querySelector('.theme-switcher');
        const themes = {
            default: 'monokai',
            dark: 'dracula',
            light: 'default'
        };

        themeSwitcher.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const theme = button.dataset.theme;
            editor.setOption('theme', themes[theme]);
            
            // Update active state
            themeSwitcher.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn === button);
            });
        });

        // Spell checker
        const spellCheckToggle = document.getElementById('spellCheckToggle');
        const spellStatus = document.getElementById('spellStatus');
        const spellSuggestions = document.getElementById('spellSuggestions');
        let typo = null;

        // Load dictionary
        fetch('https://cdn.jsdelivr.net/npm/typo-js@3.3.0/typo/en_US.aff')
            .then(response => response.text())
            .then(aff => {
                fetch('https://cdn.jsdelivr.net/npm/typo-js@3.3.0/typo/en_US.dic')
                    .then(response => response.text())
                    .then(dic => {
                        typo = new Typo('en_US', aff, dic);
                        spellCheckToggle.disabled = false;
                    });
            });

        function checkSpelling() {
            if (!typo) return;

            const text = editor.getValue();
            const words = text.match(/\b\w+\b/g) || [];
            const misspelledWords = words.filter(word => !typo.check(word));

            // Mark misspelled words
            const doc = editor.getDoc();
            const marks = doc.getAllMarks();
            marks.forEach(mark => mark.clear());

            misspelledWords.forEach(word => {
                const cursor = doc.getSearchCursor(word);
                while (cursor.findNext()) {
                    doc.markText(cursor.from(), cursor.to(), {
                        className: 'misspelled',
                        attributes: { 'data-word': word }
                    });
                }
            });

            spellStatus.textContent = `Spell check: ${misspelledWords.length} errors`;
        }

        // Show suggestions on click
        editor.getWrapperElement().addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('misspelled')) {
                const word = target.getAttribute('data-word');
                const suggestions = typo.suggest(word);
                
                if (suggestions.length > 0) {
                    spellSuggestions.innerHTML = suggestions
                        .slice(0, 5)
                        .map(suggestion => `
                            <div class="suggestion" data-word="${suggestion}">
                                ${suggestion}
                            </div>
                        `)
                        .join('');

                    const rect = target.getBoundingClientRect();
                    spellSuggestions.style.top = `${rect.bottom + window.scrollY}px`;
                    spellSuggestions.style.left = `${rect.left}px`;
                    spellSuggestions.classList.add('show');
                }
            } else {
                spellSuggestions.classList.remove('show');
            }
        });

        // Replace word with suggestion
        spellSuggestions.addEventListener('click', (e) => {
            const suggestion = e.target.closest('.suggestion');
            if (!suggestion) return;

            const word = suggestion.dataset.word;
            const cursor = editor.getCursor();
            const line = editor.getLine(cursor.line);
            const start = line.lastIndexOf(' ', cursor.ch) + 1;
            const end = line.indexOf(' ', cursor.ch);
            
            editor.replaceRange(word, 
                { line: cursor.line, ch: start }, 
                { line: cursor.line, ch: end === -1 ? line.length : end }
            );

            spellSuggestions.classList.remove('show');
        });

        spellCheckToggle.addEventListener('change', () => {
            if (spellCheckToggle.checked) {
                checkSpelling();
            } else {
                const doc = editor.getDoc();
                const marks = doc.getAllMarks();
                marks.forEach(mark => mark.clear());
                spellStatus.textContent = 'Spell check: Off';
            }
        });

        // Font size control
        const fontSizeControl = document.querySelector('.font-size-control');
        let fontSize = 100;

        fontSizeControl.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            switch (action) {
                case 'font-decrease':
                    fontSize = Math.max(50, fontSize - 10);
                    break;
                case 'font-increase':
                    fontSize = Math.min(200, fontSize + 10);
                    break;
                case 'font-reset':
                    fontSize = 100;
                    break;
            }

            const wrapper = editor.getWrapperElement();
            wrapper.style.fontSize = `${fontSize}%`;
            button.textContent = `${fontSize}%`;
        });

        // Search and Replace
        const searchReplace = document.querySelector('.search-replace');
        const searchInput = document.getElementById('searchInput');
        const replaceInput = document.getElementById('replaceInput');
        const searchStatus = document.getElementById('searchStatus');
        let currentMatch = null;

        function toggleSearch() {
            searchReplace.classList.toggle('show');
            if (searchReplace.classList.contains('show')) {
                searchInput.focus();
            }
        }

        document.querySelector('[data-action="search-replace"]').addEventListener('click', toggleSearch);

        function findNext() {
            const query = searchInput.value;
            if (!query) return;

            const cursor = editor.getSearchCursor(query, currentMatch ? currentMatch.to() : null);
            if (!cursor.find()) {
                cursor.from(editor.firstLine(), 0);
                if (!cursor.find()) {
                    searchStatus.textContent = 'No matches found';
                    return;
                }
            }

            editor.setSelection(cursor.from(), cursor.to());
            editor.scrollIntoView({ from: cursor.from(), to: cursor.to() }, 20);
            currentMatch = cursor;
            updateSearchStatus();
        }

        function findPrev() {
            const query = searchInput.value;
            if (!query) return;

            const cursor = editor.getSearchCursor(query, currentMatch ? currentMatch.from() : null);
            let found = cursor.find(true);

            if (!found) {
                cursor.from(editor.lastLine(), editor.getLine(editor.lastLine()).length);
                found = cursor.find(true);
                if (!found) {
                    searchStatus.textContent = 'No matches found';
                    return;
                }
            }

            editor.setSelection(cursor.from(), cursor.to());
            editor.scrollIntoView({ from: cursor.from(), to: cursor.to() }, 20);
            currentMatch = cursor;
            updateSearchStatus();
        }

        function replace() {
            if (!currentMatch) return;
            currentMatch.replace(replaceInput.value);
            findNext();
        }

        function replaceAll() {
            const query = searchInput.value;
            const replacement = replaceInput.value;
            if (!query) return;

            let cursor = editor.getSearchCursor(query);
            let count = 0;
            while (cursor.find()) {
                cursor.replace(replacement);
                count++;
            }
            searchStatus.textContent = `Replaced ${count} occurrences`;
        }

        function updateSearchStatus() {
            const query = searchInput.value;
            let count = 0;
            let cursor = editor.getSearchCursor(query);
            while (cursor.find()) count++;
            searchStatus.textContent = `${count} matches found`;
        }

        document.getElementById('findNextBtn').addEventListener('click', findNext);
        document.getElementById('findPrevBtn').addEventListener('click', findPrev);
        document.getElementById('replaceBtn').addEventListener('click', replace);
        document.getElementById('replaceAllBtn').addEventListener('click', replaceAll);
        searchInput.addEventListener('input', () => {
            currentMatch = null;
            if (searchInput.value) {
                findNext();
            } else {
                searchStatus.textContent = '';
            }
        });

        // Print View
        const printView = document.querySelector('.print-view');
        const printContent = document.getElementById('printContent');
        const closePrintView = document.getElementById('closePrintView');

        document.querySelector('[data-action="print"]').addEventListener('click', () => {
            const content = preview.innerHTML;
            printContent.innerHTML = content;
            printView.classList.add('show');
        });

        closePrintView.addEventListener('click', () => {
            printView.classList.remove('show');
        });

        printView.addEventListener('click', (e) => {
            if (e.target === printView) {
                printView.classList.remove('show');
            }
        });

        // Drag & Drop
        const dropZone = document.querySelector('.drop-zone');
        const editorCard = document.querySelector('.editor-card');

        editorCard.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            if (e.target === dropZone) {
                dropZone.classList.remove('active');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editor.setValue(e.target.result);
                };
                reader.readAsText(file);
            } else {
                alert('Please drop a valid Markdown (.md) or text (.txt) file.');
            }
        });

        // Section Folding
        let sectionFoldingEnabled = false;

        function toggleSectionFolding() {
            sectionFoldingEnabled = !sectionFoldingEnabled;
            const content = editor.getValue();
            const lines = content.split('\n');
            
            if (sectionFoldingEnabled) {
                let currentSection = null;
                let sectionContent = [];
                
                lines.forEach((line, index) => {
                    if (line.startsWith('#')) {
                        if (currentSection) {
                            const marker = editor.markText(
                                { line: currentSection.start, ch: 0 },
                                { line: index - 1, ch: lines[index - 1].length },
                                {
                                    collapsed: false,
                                    widget: createFoldWidget()
                                }
                            );
                            currentSection.marker = marker;
                        }
                        currentSection = {
                            start: index,
                            title: line
                        };
                    }
                });
                
                if (currentSection) {
                    const marker = editor.markText(
                        { line: currentSection.start, ch: 0 },
                        { line: lines.length - 1, ch: lines[lines.length - 1].length },
                        {
                            collapsed: false,
                            widget: createFoldWidget()
                        }
                    );
                    currentSection.marker = marker;
                }
            } else {
                editor.getAllMarks().forEach(marker => marker.clear());
            }
        }

        function createFoldWidget() {
            const widget = document.createElement('span');
            widget.innerHTML = ' <span class="section-fold">[-]</span>';
            widget.querySelector('.section-fold').addEventListener('click', (e) => {
                const marker = e.target.parentElement.marker;
                if (marker) {
                    marker.collapsed = !marker.collapsed;
                    e.target.textContent = marker.collapsed ? '[+]' : '[-]';
                }
            });
            return widget;
        }

        document.querySelector('[data-action="toggle-section-fold"]').addEventListener('click', toggleSectionFolding);

        // Line Numbers Toggle
        document.querySelector('[data-action="toggle-line-numbers"]').addEventListener('click', () => {
            const current = editor.getOption('lineNumbers');
            editor.setOption('lineNumbers', !current);
        });

        // Smart Paste
        editor.on('paste', (cm, e) => {
            e.preventDefault();
            
            const clipboard = e.clipboardData || window.clipboardData;
            const text = clipboard.getData('text/html') || clipboard.getData('text');
            
            if (clipboard.getData('text/html')) {
                // Convert HTML to Markdown
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                
                const markdown = convertHtmlToMarkdown(tempDiv);
                const doc = editor.getDoc();
                const cursor = doc.getCursor();
                doc.replaceRange(markdown, cursor);
            } else {
                // Regular text paste
                const doc = editor.getDoc();
                const cursor = doc.getCursor();
                doc.replaceRange(text, cursor);
            }
        });

        function convertHtmlToMarkdown(element) {
            let markdown = '';
            
            for (const node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    markdown += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    switch (node.tagName.toLowerCase()) {
                        case 'h1':
                            markdown += `# ${node.textContent}\n`;
                            break;
                        case 'h2':
                            markdown += `## ${node.textContent}\n`;
                            break;
                        case 'h3':
                            markdown += `### ${node.textContent}\n`;
                            break;
                        case 'p':
                            markdown += `${node.textContent}\n\n`;
                            break;
                        case 'strong':
                        case 'b':
                            markdown += `**${node.textContent}**`;
                            break;
                        case 'em':
                        case 'i':
                            markdown += `*${node.textContent}*`;
                            break;
                        case 'a':
                            markdown += `[${node.textContent}](${node.href})`;
                            break;
                        case 'img':
                            markdown += `![${node.alt}](${node.src})`;
                            break;
                        case 'code':
                            markdown += `\`${node.textContent}\``;
                            break;
                        case 'pre':
                            markdown += `\`\`\`\n${node.textContent}\n\`\`\`\n`;
                            break;
                        case 'ul':
                            for (const li of node.children) {
                                markdown += `- ${li.textContent}\n`;
                            }
                            markdown += '\n';
                            break;
                        case 'ol':
                            let i = 1;
                            for (const li of node.children) {
                                markdown += `${i}. ${li.textContent}\n`;
                                i++;
                            }
                            markdown += '\n';
                            break;
                        default:
                            markdown += convertHtmlToMarkdown(node);
                    }
                }
            }
            
            return markdown;
        }

        // Style Formatter
        document.querySelector('[data-action="format"]').addEventListener('click', () => {
            const content = editor.getValue();
            const formatted = formatMarkdown(content);
            editor.setValue(formatted);
        });

        function formatMarkdown(content) {
            const lines = content.split('\n');
            let formatted = '';
            let inCodeBlock = false;
            let lastLineEmpty = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                // Handle code blocks
                if (line.startsWith('```')) {
                    inCodeBlock = !inCodeBlock;
                    formatted += line + '\n';
                    continue;
                }
                
                if (!inCodeBlock) {
                    // Add space after list markers
                    line = line.replace(/^(-|\*|\+)(?=\S)/, '$1 ');
                    line = line.replace(/^(\d+\.)(?=\S)/, '$1 ');
                    
                    // Add space after headers
                    line = line.replace(/^(#{1,6})(?=\S)/, '$1 ');
                    
                    // Ensure consistent list marker
                    line = line.replace(/^[*+-](?=\s)/, '-');
                    
                    // Add blank lines around headers and lists
                    if (line.match(/^#{1,6}\s/) || line.match(/^(-|\d+\.)\s/)) {
                        if (!lastLineEmpty && formatted.length > 0) {
                            formatted += '\n';
                        }
                    }
                }
                
                formatted += line + '\n';
                lastLineEmpty = line.length === 0;
            }
            
            return formatted.trim();
        }

        // Tab Support
        const documentTabs = document.getElementById('documentTabs');
        const documents = new Map();
        let activeTab = null;

        function createTab() {
            const id = 'doc-' + Date.now();
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.id = id;
            tab.innerHTML = `
                <span>Untitled</span>
                <span class="tab-close">×</span>
            `;
            
            documents.set(id, {
                content: '',
                name: 'Untitled'
            });
            
            documentTabs.insertBefore(tab, document.getElementById('newTab'));
            switchTab(id);
            
            return id;
        }

        function switchTab(id) {
            if (activeTab) {
                documents.get(activeTab).content = editor.getValue();
                document.querySelector(`[data-id="${activeTab}"]`).classList.remove('active');
            }
            
            activeTab = id;
            editor.setValue(documents.get(id).content);
            document.querySelector(`[data-id="${id}"]`).classList.add('active');
        }

        function closeTab(id) {
            if (documents.size === 1) return;
            
            documents.delete(id);
            document.querySelector(`[data-id="${id}"]`).remove();
            
            if (id === activeTab) {
                const newTab = documents.keys().next().value;
                switchTab(newTab);
            }
        }

        document.getElementById('newTab').addEventListener('click', createTab);

        documentTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (!tab) return;
            
            if (e.target.classList.contains('tab-close')) {
                closeTab(tab.dataset.id);
            } else {
                switchTab(tab.dataset.id);
            }
        });

        // Create initial tab
        createTab();

        // Focus Mode
        const focusMode = document.querySelector('.focus-mode');
        const focusEditor = CodeMirror.fromTextArea(document.getElementById('focusEditor'), {
            mode: 'markdown',
            theme: 'monokai',
            lineNumbers: true,
            lineWrapping: true,
            spellcheck: true,
            autofocus: true
        });

        document.querySelector('[data-action="focus"]').addEventListener('click', () => {
            focusEditor.setValue(editor.getValue());
            focusMode.classList.add('show');
            document.body.style.overflow = 'hidden';
        });

        document.getElementById('exitFocus').addEventListener('click', () => {
            editor.setValue(focusEditor.getValue());
            focusMode.classList.remove('show');
            document.body.style.overflow = '';
        });

        // Full-screen Mode
        let isFullscreen = false;

        document.querySelector('[data-action="fullscreen"]').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                isFullscreen = true;
            } else {
                document.exitFullscreen();
                isFullscreen = false;
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                isFullscreen = false;
            }
        });

        // File History
        const fileHistory = document.querySelector('.file-history');
        const historyList = document.getElementById('historyList');
        const historyToggle = document.querySelector('.history-toggle');
        let history = JSON.parse(localStorage.getItem('markdownHistory') || '[]');

        function updateHistory() {
            const currentContent = editor.getValue();
            const currentName = documents.get(activeTab).name;
            
            const existingIndex = history.findIndex(item => item.name === currentName);
            if (existingIndex !== -1) {
                history[existingIndex] = {
                    name: currentName,
                    content: currentContent,
                    timestamp: Date.now()
                };
            } else {
                history.unshift({
                    name: currentName,
                    content: currentContent,
                    timestamp: Date.now()
                });
            }
            
            // Keep only last 10 files
            history = history.slice(0, 10);
            localStorage.setItem('markdownHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = history.map(item => `
                <div class="history-item ${item.name === documents.get(activeTab)?.name ? 'active' : ''}" 
                     data-name="${item.name}">
                    <span>${item.name}</span>
                    <span class="history-close">×</span>
                </div>
            `).join('');
        }

        function loadFromHistory(name) {
            const item = history.find(item => item.name === name);
            if (item) {
                editor.setValue(item.content);
                documents.get(activeTab).name = name;
                document.querySelector(`[data-id="${activeTab}"] span:first-child`).textContent = name;
                fileHistory.classList.remove('show');
            }
        }

        historyToggle.addEventListener('click', () => {
            fileHistory.classList.toggle('show');
        });

        historyList.addEventListener('click', (e) => {
            const item = e.target.closest('.history-item');
            if (!item) return;
            
            if (e.target.classList.contains('history-close')) {
                const name = item.dataset.name;
                history = history.filter(item => item.name !== name);
                localStorage.setItem('markdownHistory', JSON.stringify(history));
                renderHistory();
            } else {
                loadFromHistory(item.dataset.name);
            }
        });

        // Update history when content changes
        editor.on('change', () => {
            if (autoSaveToggle.checked) {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    saveContent();
                    updateHistory();
                }, 1000);
            }
        });

        // Initial history render
        renderHistory();
    </script>
</body>
</html> 